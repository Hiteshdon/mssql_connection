<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>How Dost Thy Linker Link?</title><link rel="stylesheet" type="text/css" href="userguide.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="FreeTDS User Guide" /><link rel="up" href="rtl.html" title="Appendix A. On Linkers" /><link rel="prev" href="linker.library.check.html" title="Checking if a Library Provides a Function" /><link rel="next" href="linker.conclusion.html" title="Keep in Mind" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">How Dost Thy Linker Link? </th></tr><tr><td width="20%" align="left"><a accesskey="p" href="linker.library.check.html">Prev</a> </td><th width="60%" align="center">Appendix A. On Linkers</th><td width="20%" align="right"> <a accesskey="n" href="linker.conclusion.html">Next</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="linker.how"></a>How Dost Thy Linker Link? </h2></div></div></div><p>Now at last we come to how the linker performs its magic.  Once again the discussion divides between static and dynamic linking.  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm71991280"></a>Static Linker</h3></div></div></div><p>Static linking happens at build time.  Object files are collected together; a distinct list of all function names is created, and the linker is tasked with finding a definition for each one.  </p><p>Different linkers have different command-line options to support OS-specific features.  This document isn't intended to teach how to use any particular linker.  Our task here is to understand the principles involved, so that you can apply them to your particular situation.  </p><p>The static linker needs three kinds of information:
</p><div class="orderedlist"><p class="title"><strong>Static linker inputs</strong></p><ol class="orderedlist" type="1"><li class="listitem"><p>Object modules to be linked, including libraries </p></li><li class="listitem"><p>Locations of libraries </p></li><li class="listitem"><p>Search order </p></li></ol></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm71995376"></a>Knitting together the object modules</h4></div></div></div><p>The static linker merges your object files into one executable.  Your project's object files may refer freely (usually) to each other's functions, and the linker will match them up.  It will catenate them together, compute every function's offset from the start of the executable, and replace every function reference with the actual address needed for the executable it's constructing.  For library functions, definitions are copied from the library and appended to the output file (executable).  The placeholder addresses left by the compiler are similarly replaced by offsets.  </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm71994224"></a>Specifying libraries</h4></div></div></div><p></p><p>An application programmer using <span class="productname">FreeTDS</span> will need to mention the name fo the <span class="productname">FreeTDS</span> library being used.  Failure to do so will provoke the dread <em class="firstterm">undefined reference</em> linker error: 

</p><div class="example"><a id="idm71991664"></a><p class="title"><strong>Example A.1. Missing library name</strong></p><div class="example-contents"><pre class="screen"><code class="prompt">$ </code><strong class="userinput"><code>gcc -o bsqldb bsqldb.o  </code></strong>
<code class="computeroutput">bsqldb.o: In function `get_login':
../../../src/apps/bsqldb.c:816: undefined reference to `dblogin'
../../../src/apps/bsqldb.c:823: undefined reference to `dbsetlname'
../../../src/apps/bsqldb.c:874: undefined reference to `dbsetlname'
../../../src/apps/bsqldb.c:884: undefined reference to `dbsetlname'
../../../src/apps/bsqldb.c:889: undefined reference to `dbsetlname'
…</code>
</pre></div></div><p><br class="example-break" />
</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm72017648"></a>Finding libraries</h4></div></div></div><p>Specifying the library is necessary but may be insufficient.  The linker may need to be told where to look for the library.  This is often the case for the application programmer using <span class="productname">FreeTDS</span> because the <span class="productname">FreeTDS</span> libraries may be installed in a location not on the linker's default search path.  Linkers are usually pretty blunt about missing libraries: 

</p><div class="example"><a id="idm72023920"></a><p class="title"><strong>Example A.2. Library not found</strong></p><div class="example-contents"><pre class="screen"><code class="prompt">$ </code><strong class="userinput"><code>gcc -o bsqldb bsqldb.o  -l sybdb</code></strong>
<code class="computeroutput">ld: cannot find -lsybdb</code>
</pre></div></div><p><br class="example-break" />
</p><p><span class="emphasis"><em>Order matters</em></span>.  Linkers tend to be fussy about library search order, some more than others.  It's good practice to tell the linker to search project libraries first, third-party libraries (e.g. iconv or kerberos) next, and finally system libraries.  </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="linker.dynamic"></a>Dynamic Linker</h3></div></div></div><p>The dynamic linker — also known as the runtime linker — is, like the rest of dynamic linking, more complicated than its static counterpart.  Whereas it's impossible even to generate an executable with missing static function references, an executable that uses dynamic libraries depends on the runtime environment to have its references satisfied.</p><p>When a dynamically linked application is launched, the OS invokes the runtime linker to resolve any undefined references.  Much as the static linker does, the runtime linker consults a list of dynamic libraries along its configured search path.  The names of the libraries to search for are embedded in the executable.  Sometimes, not always, the search path is found in the executable too.  Usually any embedded path can be overridden.  </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="linker.dynamic.the.executable"></a>Information in the executable</h4></div></div></div><p>Exactly what information is in the executable and how to display it depends on the format of the executable.  Different OSes use different formats and most Unix derivatives actually support at least two.  The most commonly encountered format for the <span class="productname">FreeTDS</span> programmer is the ELF format.  In the interest of your time and mine, that's the one we'll examine here.  </p><p>The GNU bintool utility <span class="command"><strong>readelf</strong></span> displays the information in the executable that is input to the runtime linker:

</p><pre class="screen"><code class="prompt">$ </code><strong class="userinput"><code>readelf -d src/apps/.libs/bsqldb</code></strong>
<code class="computeroutput">Dynamic section at offset 0x6028 contains 20 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libsybdb.so.5]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.12]
 0x000000000000000f (RPATH)              Library rpath: [/usr/pkg/lib:/usr/local/lib]
…</code>
</pre><p>
	</p><p>What is this telling us?  First, the <code class="filename">bsqldb</code> executable uses three shared libraries, namely <code class="literal">sybdb</code> for <code class="systemitem">DB-Library</code>, <code class="literal">pthread</code> for POSIX threads, and <code class="literal">c</code>, the C standard library.  The runtime linker is going to have to find those somewhere, and it's going to use only those libraries to resolve unresolved references in the executable.  </p><p>Second, <span class="command"><strong>readelf</strong></span> displays the <code class="literal">RPATH</code>.  The runtime linker searches for the required dynamic libraries in the directories listed in the <code class="literal">RPATH</code>, if extant.  </p><p>The <code class="literal">RPATH</code> is placed in the executable by the static linker.  It can be thought of as a hint from the application builder to the system administrator.  If an executable is built with an appropriate <code class="literal">RPATH</code>, the runtine linker will have all the information it needs to find the required libraries.   </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="linker.dynamic.ld.so"></a>Information outside the executable</h4></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../images/note.gif" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Runtime linkers differ.  The advice and observations that follow apply in many situations, but not all.  The best way to know how <span class="emphasis"><em>yours</em></span> works is to consult your system's documentation.  RTFM!  </p></td></tr></table></div><p>The NetBSD and GNU linkers both (as of this writing on machines used by the author) honor a configuration file and environment variables.  They also have compiled-in default search locations.  At a minimum, the default is <code class="filename">/usr/lib</code>.  Sometimes a configuration file extends this to <code class="filename">/usr/local/lib</code>.   </p><p>The primary environment variable is <code class="envar">LD_LIBRARY_PATH</code>.  On some systems this <span class="emphasis"><em>overrides</em></span> the <code class="literal">RPATH</code> in the executable.  In others it doesn't.  Where ineffective, specific libraries (not their paths) can be forceably used with <code class="envar">LD_PRELOAD</code>.  </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="linker.dynamic.ldd"></a>Displaying what the Runtime linker will do</h4></div></div></div><p>The <span class="command"><strong>ldd(1)</strong></span> shows which dynamic libraries an executable requires and where, if at all, they'll be found:

</p><pre class="screen"><code class="prompt">$ </code><strong class="userinput"><code>ldd $(command -v bsqldb)</code></strong>
<code class="computeroutput">/usr/local/bin/bsqldb:
        -lc.12 =&gt; /usr/lib/libc.so.12
        -lpthread.0 =&gt; /usr/lib/libpthread.so.0
        -lsybdb.5 =&gt; /usr/local/lib/libsybdb.so.5</code>
</pre><p>

Important to understand: <span class="command"><strong>ldd</strong></span> is <span class="emphasis"><em>not</em></span> figuring out this information by itself.  It just reports the results of its interrogation of the runtime linker.  As the configuration of the runtime linker is changed, so changes the output of <span class="command"><strong>ldd</strong></span>.  </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="linker.dynamic.win32"></a>A Word about Windows®</h4></div></div></div><p>Windows executables use PE format (derived from the older COFF format), which has no provision for an <code class="literal">RPATH</code>.
The runtime linker searches the <code class="literal">PATH</code> instead, after some built-in locations that usually include the current working directory.
Neither <span class="command"><strong>ldd</strong></span> nor any similar utility is included in the basic product.</p><p>It has been said that Unix is for <span class="emphasis"><em>programmers</em></span> and Windows is for <span class="emphasis"><em>users</em></span>, and perhaps that roughly describes the  intention.  But the Unix features listed above — <code class="literal">RPATH</code> and <span class="command"><strong>ldd</strong></span> — as well as a canonical filesystem hierarchy and dynamic library versioning, all promote a better <span class="emphasis"><em>user</em></span> experience.  Because of them, the problem of DLL conflicts in Windows hardly exists in Unix.  Yet they are neither new nor secrect nor patented nor complicated; Microsoft could have adopted them years ago (as Apple finally did).  We therefore know that the 20-year old phenomemon known as “DLL hell” is not inevitable, but a <span class="emphasis"><em>choice</em></span> signifying nothing so much as Microsoft's indifference to its customers.
Recently Microsoft added support to configure different search paths and other attributes based on <code class="literal">Application Manifests</code>
and <code class="literal">Application Configuration Files</code>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="linker.dynamic.advice"></a>Advice for the lazy</h4></div></div></div><p>To avoid tinkering with your runtime linker, embed an <code class="literal">RPATH</code> in your executable commensurate with its intended runtime environment.  If <span class="command"><strong>ldd</strong></span> doesn't show the libraries you want, or some are not found, use <span class="command"><strong>readelf</strong></span> to see which libraries are used and the <code class="literal">RPATH</code>.  Relink with a better <code class="literal">RPATH</code> if needed.  </p><p>When testing with new libraries, use <code class="envar">LD_PRELOAD</code> to override the default, taking care that the semantics haven't changed.  </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="linker.library.check.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="rtl.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="linker.conclusion.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Checking if a Library Provides a Function </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Keep in Mind</td></tr></table></div></body></html>